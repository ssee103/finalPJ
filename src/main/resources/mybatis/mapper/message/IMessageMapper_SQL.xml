<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.message.mapper.IMessageMapper">
    <!-- receiverId Ï¶â, mrReceiverÎ•º Í∞ÄÏ†∏Ïò§Í∏∞ ÏúÑÌïú MessageResultMap -->
    <resultMap id="MessageResultMap" type="kr.or.ddit.message.vo.MessageVO">
        <id property="msgNo" column="msg_no"/>
        <result property="msgSender" column="msg_sender"/>
        <result property="senderName" column="sender_name"/>
        <result property="msgContent" column="msg_content"/>
        <result property="msgDate" column="msg_date"/>
        <result property="msgDel" column="msg_del"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="receiverName" column="receiver_name"/>
    </resultMap>

    <!-- ÏÇ¨ÏõêÎ™Ö ÌòπÏùÄ ÏÇ¨ÏõêÎ≤àÌò∏Ïóê Ìï¥ÎãπÌïòÎäî ÏßÅÏõê Ï°∞Ìöå -->
    <select id="selectEmployee" parameterType="String" resultType="kr.or.ddit.employee.vo.EmployeeVO">
        SELECT 
              empl_no
            , empl_nm
        FROM employee
        WHERE empl_no = #{receiver} OR empl_nm = #{receiver}
    </select>

    <!-- üì® ÏàòÏã†Ïûê Ï†ïÎ≥¥ Ï†ÄÏû• -->
    <insert id="insertReceiver" parameterType="kr.or.ddit.message.vo.MessageReceiverVO">
        <selectKey keyProperty="mrNo" resultType="Long" order="BEFORE">
            SELECT msg_receiver_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO msg_receiver (
              mr_no
            , msg_no
            , mr_receiver
            , mr_date
            , mr_del)
        VALUES (
              #{mrNo}
            , #{msgNo}
            , #{mrReceiver}
            , SYSDATE
            , 'N'
        )
    </insert>

    <!-- Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅÏùÑ ÏúÑÌïú MessageResultMap -->
    <select id="getFilteredMessages" parameterType="map" resultMap="MessageResultMap">
        SELECT 
              m.msg_no
            , m.msg_sender
            , m.msg_content
            , m.msg_date
            , r.mr_del
            , r.mr_receiver AS receiver_id
        FROM message m
        JOIN msg_receiver r ON m.msg_no = r.msg_no
        WHERE r.mr_receiver = #{userId} 
        AND r.mr_del = 'N'
        <if test="filterDate != null and filterDate != ''">
            AND TO_CHAR(m.msg_date, 'YYYY-MM-DD') = #{filterDate}
        </if>
        <if test="filterContent != null and filterContent != ''">
            AND LOWER(m.msg_content) LIKE '%' || #{filterContent} || '%'
        </if>
        ORDER BY m.msg_date DESC
    </select>


    <!-- üì® Î©îÏãúÏßÄ Ï†ÄÏû• -->
    <insert id="sendMessage" parameterType="kr.or.ddit.message.vo.MessageVO">
        <selectKey keyProperty="msgNo" resultType="Long" order="BEFORE">
            SELECT message_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO message (
              msg_no
            , msg_sender
            , msg_content
            , msg_date
            , msg_del
        )
        VALUES (
              #{msgNo}
            , #{msgSender}
            , #{msgContent}
            , SYSDATE
            , 'N'
        )
    </insert>

    <!-- üì® Î∞õÏùÄ Ï™ΩÏßÄ Î™©Î°ù Ï°∞Ìöå -->
    <select id="getReceivedMessages" parameterType="String" resultMap="MessageResultMap">
        SELECT 
              m.msg_no
            , m.msg_sender
            , e1.empl_nm || ' (' || e1.empl_no || ')' AS sender_name
            , m.msg_content
            , m.msg_date
            , r.mr_del
            , r.mr_receiver AS receiver_id,
            e2.empl_nm || ' (' || e2.empl_no || ')' AS receiver_name
        FROM message m
        JOIN msg_receiver r ON m.msg_no = r.msg_no
        JOIN employee e1 ON m.msg_sender = e1.empl_no 
        JOIN employee e2 ON r.mr_receiver = e2.empl_no 
        WHERE r.mr_receiver = #{mrReceiver} 
        AND r.mr_del = 'N'
        ORDER BY m.msg_date DESC
    </select>


    <!-- üì§ Î≥¥ÎÇ∏ Ï™ΩÏßÄ Î™©Î°ù Ï°∞Ìöå -->
    <select id="getSentMessages" resultMap="MessageResultMap">
        SELECT 
              m.msg_no
            , m.msg_sender
            , e1.empl_nm || ' (' || e1.empl_no || ')' AS sender_name
            , m.msg_content
            , m.msg_date
            , m.msg_del
            , LISTAGG(r.mr_receiver, ',') WITHIN GROUP (ORDER BY r.mr_receiver) AS receiver_id
            , LISTAGG(e2.empl_nm || ' (' || e2.empl_no || ')', ',') WITHIN GROUP (ORDER BY e2.empl_no) AS receiver_name
        FROM message m
        LEFT JOIN msg_receiver r ON m.msg_no = r.msg_no
        LEFT JOIN employee e1 ON m.msg_sender = e1.empl_no  
        LEFT JOIN employee e2 ON r.mr_receiver = e2.empl_no 
        WHERE m.msg_sender = #{userId}
        AND m.msg_del = 'N'
        GROUP BY 
              m.msg_no
            , m.msg_sender
            , e1.empl_nm
            , e1.empl_no
            , m.msg_content
            , m.msg_date
            , m.msg_del
        ORDER BY m.msg_date DESC
    </select>

    <!-- üóë Ìú¥ÏßÄÌÜµ Î™©Î°ù Ï°∞Ìöå -->
    <select id="getTrashMessages" parameterType="String" resultMap="MessageResultMap">
        SELECT 
              m.msg_no
            , m.msg_sender
            , e1.empl_nm || ' (' || e1.empl_no || ')' AS sender_name
            , m.msg_content
            , m.msg_date
            , m.msg_del
            , LISTAGG(r.mr_receiver, ',') WITHIN GROUP (ORDER BY r.mr_receiver) AS receiver_id
            , LISTAGG(e2.empl_nm || ' (' || e2.empl_no || ')', ',') WITHIN GROUP (ORDER BY e2.empl_no) AS receiver_name
            , r.mr_del
        FROM message m
        LEFT JOIN msg_receiver r ON m.msg_no = r.msg_no
        LEFT JOIN employee e1 ON m.msg_sender = e1.empl_no  
        LEFT JOIN employee e2 ON r.mr_receiver = e2.empl_no 
        WHERE (m.msg_del = 'Y' OR r.mr_del = 'Y')
        AND (m.msg_sender = #{userId} OR r.mr_receiver = #{userId})
        GROUP BY 
              m.msg_no
            , m.msg_sender
            , e1.empl_nm
            , e1.empl_no
            , m.msg_content
            , m.msg_date
            , m.msg_del
            , r.mr_del
        ORDER BY m.msg_date DESC
    </select>


    <!-- Î≥¥ÎÇ∏ Ï™ΩÏßÄ Ìú¥ÏßÄÌÜµÏúºÎ°ú Ïù¥Îèô -->
    <update id="moveToTrashSent" parameterType="int">
        UPDATE message 
        SET msg_del = 'Y' 
        WHERE msg_no = #{msgNo}
    </update>

    <!-- Î∞õÏùÄ Ï™ΩÏßÄ Ìú¥ÏßÄÌÜµÏúºÎ°ú Ïù¥Îèô -->
    <update id="moveToTrashReceived">
        UPDATE msg_receiver 
        SET mr_del = 'Y' 
        WHERE msg_no = #{msgNo} AND mr_receiver = #{userId}
    </update>

    <!-- Î≥¥ÎÇ∏ Ï™ΩÏßÄ Î≥µÏõê -->
    <update id="restoreSentMessage" parameterType="int">
        UPDATE message 
        SET msg_del = 'N' 
        WHERE msg_no = #{msgNo}
    </update>

    <!-- Î∞õÏùÄ Ï™ΩÏßÄ Î≥µÏõê -->
    <update id="restoreReceivedMessage">
        UPDATE msg_receiver 
        SET mr_del = 'N' 
        WHERE msg_no = #{msgNo} AND mr_receiver = #{userId}
    </update>

    <!-- üì¢ ÏïåÎ¶º(Notification) Ï†ÄÏû• -->
<!--     
	<insert id="insertNotification" parameterType="kr.or.ddit.message.vo.NotificationVO">
        INSERT INTO notification (
              ntcn_no
            , nt_code
            , ntcn_recp
            , ntcn_content
            , ntcn_date
            , ntcn_chk)
        VALUES (
              notification_seq.NEXTVAL
            , #{ntCode}
            , #{ntcnRecp}
            , #{ntcnContent}
            , SYSDATE
            , 'N')
    </insert> 
-->

    <!-- üîî ÌäπÏ†ï ÏÇ¨Ïö©ÏûêÏùò ÏïåÎ¶º Ï°∞Ìöå -->
<!--
     <select id="getNotifications" parameterType="string" resultType="kr.or.ddit.message.vo.NotificationVO">
        SELECT * FROM notification 
        WHERE ntcn_recp = #{receiverId} 
        ORDER BY ntcn_date DESC
    </select> 
-->

    <!-- ‚úÖ Ï™ΩÏßÄ ÏùΩÏùå Ï≤òÎ¶¨ -->
    <update id="markAsRead" parameterType="int">
        UPDATE msg_receiver
        SET mr_read = 'Y'
        WHERE msg_no = #{msgNo}
    </update>

    <!-- üì© Î∞õÏùÄ Ï™ΩÏßÄ Í∞úÏàò -->
    <select id="countReceivedMessages" resultType="int">
        SELECT COUNT(*) 
        FROM message m
        JOIN msg_receiver r ON m.msg_no = r.msg_no
        WHERE r.mr_receiver = #{userId} 
        AND r.mr_del = 'N'
    </select>

    <!-- üì§ Î≥¥ÎÇ∏ Ï™ΩÏßÄ Í∞úÏàò -->
    <select id="countSentMessages" resultType="int">
        SELECT COUNT(*) 
        FROM message 
        WHERE msg_sender = #{userId} 
        AND msg_del = 'N'
    </select>

    <!-- üóë Ìú¥ÏßÄÌÜµ Í∞úÏàò -->
    <select id="countTrashMessages" resultType="int">
        SELECT COUNT(DISTINCT m.msg_no) 
        FROM message m 
        LEFT JOIN msg_receiver r ON m.msg_no = r.msg_no 
        WHERE (m.msg_del = 'Y' OR r.mr_del = 'Y') 
        AND (m.msg_sender = #{userId} OR r.mr_receiver = #{userId})
    </select>

    <!-- ‚ùå Ï™ΩÏßÄ ÏôÑÏ†Ñ ÏÇ≠Ï†ú -->
    <delete id="deleteMessage">
        DELETE FROM message WHERE msg_no = #{msgNo}
    </delete>

    <!-- üì® Ï™ΩÏßÄ ÏÉÅÏÑ∏ Î≥¥Í∏∞ -->
    <select id="getMessageDetail" parameterType="Long" resultType="kr.or.ddit.message.vo.MessageVO">
        SELECT 
              m.msg_no
            , m.msg_sender
            , m.msg_content
            , m.msg_date
            , m.msg_del
        FROM message m
        WHERE m.msg_no = #{msgNo}
    </select>

   <!-- üóë Î≥¥ÎÇ∏ Ï™ΩÏßÄ ÏùºÍ¥Ñ ÏÇ≠Ï†ú -->
    <delete id="batchDeleteSentMessages">
        DELETE FROM message 
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND msg_sender = #{userId}
    </delete>

    <!-- üóë Î∞õÏùÄ Ï™ΩÏßÄ ÏùºÍ¥Ñ ÏÇ≠Ï†ú -->
    <delete id="batchDeleteReceivedMessages">
        DELETE FROM msg_receiver 
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND mr_receiver = #{userId}
    </delete>

    <!-- üìå Î≥¥ÎÇ∏ Ï™ΩÏßÄ ÏùºÍ¥Ñ Ìú¥ÏßÄÌÜµ Ïù¥Îèô -->
    <update id="batchMoveSentMessagesToTrash">
        UPDATE message 
        SET msg_del = 'Y'
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND msg_sender = #{userId}
    </update>

    <!-- üìå Î∞õÏùÄ Ï™ΩÏßÄ ÏùºÍ¥Ñ Ìú¥ÏßÄÌÜµ Ïù¥Îèô -->
    <update id="batchMoveReceivedMessagesToTrash">
        UPDATE msg_receiver 
        SET mr_del = 'Y'
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND mr_receiver = #{userId}
    </update>

    <!-- ‚úÖ Î≥¥ÎÇ∏ Ï™ΩÏßÄ ÏùºÍ¥Ñ Î≥µÏõê -->
    <update id="batchRestoreSentMessages">
        UPDATE message 
        SET msg_del = 'N'
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND msg_sender = #{userId}
    </update>

    <!-- ‚úÖ Î∞õÏùÄ Ï™ΩÏßÄ ÏùºÍ¥Ñ Î≥µÏõê -->
    <update id="batchRestoreReceivedMessages">
        UPDATE msg_receiver 
        SET mr_del = 'N'
        WHERE msg_no IN 
        <foreach item="msgNo" collection="msgNos" open="(" separator="," close=")">
            #{msgNo}
        </foreach>
        AND mr_receiver = #{userId}
    </update>

    <resultMap id="employeeResultMap" type="kr.or.ddit.employee.vo.EmployeeVO">
        <result property="emplNo" column="ÏÇ¨ÏõêÎ≤àÌò∏"/>
        <result property="emplNm" column="ÏÇ¨ÏõêÎ™Ö"/>
        <result property="deptName" column="Î∂ÄÏÑúÎ™Ö"/>
        <result property="ccName" column="ÏßÅÏ±Ö"/>
    </resultMap>


   <!-- ‚úÖ ÏÇ¨Ïõê Í≤ÄÏÉâ -->
    <select id="searchEmployees" parameterType="string" resultMap="employeeResultMap">
        SELECT
              e.empl_no AS ÏÇ¨ÏõêÎ≤àÌò∏
            , e.empl_nm AS ÏÇ¨ÏõêÎ™Ö
            , d.dept_name AS Î∂ÄÏÑúÎ™Ö
            , c.cc_name AS ÏßÅÏ±Ö
        FROM employee e
        LEFT JOIN department d ON e.dept_code = d.dept_code
        LEFT JOIN common_code c
            ON e.empl_position = c.cc_code
            AND c.cg_group = 'POSITION'
        WHERE (e.empl_nm LIKE '%' || #{query} || '%'
            OR e.empl_no LIKE '%' || #{query} || '%')
        ORDER BY e.empl_nm
    </select>
</mapper>